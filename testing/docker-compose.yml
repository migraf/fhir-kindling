version: '3.8'

volumes:
  testing-blaze:
  testing-hapi:
  oidc-blaze-data:

services:
  blaze:
    image: "samply/blaze:latest"
    environment:
      JAVA_TOOL_OPTIONS: "-Xmx2g"
#      OPENID_PROVIDER_URL: "https://dev-keycloak.grafm.de/auth/realms/blaze"
      BASE_URL: "http://localhost:9090"
      DB_SYNC_TIMEOUT: 100000
      LOG_LEVEL: "debug"
    ports:
      - "9090:8080"
    volumes:
      - testing-blaze:/app/data

  hapi:
    image: "hapiproject/hapi:latest"
    ports:
      - "9091:8080"
    volumes:
      - testing-hapi:/data/hapi
    environment:
      hapi.fhir.default_encoding: json
      hapi.fhir.: json
      hapi.fhir.server_address: "http://localhost:9091/fhir"
  
  keycloak:
    image: "quay.io/keycloak/keycloak:latest"
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_IMPORT: /tmp/realm.json
    ports:
    - "8090:8080"
    volumes:
    - "./realm.json:/opt/keycloak/data/import/blaze-realm.json"
    command: start-dev --import-realm

  blaze-oidc:
    image: "samply/blaze:latest"
    environment:
      BASE_URL: "http://localhost:9092"
      JAVA_TOOL_OPTIONS: "-Xmx2g"
      OPENID_PROVIDER_URL: "http://keycloak:8080/realms/blaze"
    ports:
    - "9092:8080"
    volumes:
    - "oidc-blaze-data:/app/data"
    depends_on:
    - keycloak

